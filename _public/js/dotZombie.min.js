/*! dot-zombie 04-12-2013 */
!function(a,b){function c(a){var b=a||{};b.name=b.name||"Animal",h.call(this,b)}function d(a){var b=a||{};b.name=b.name||"SensorAnimal",h.call(this,b)}function e(a){var b=a||{};b.name=b.name||"SensorSheep",h.call(this,b)}function f(a){var b=a||{};b.name=b.name||"SensorWolf",h.call(this,b)}var g=Flora.Utils,h=Flora.Mover;g.extend(c,h),c.prototype.init=function(a){var b=a||{};c._superClass.prototype.init.call(this,b),this.followMouse=!!b.followMouse,this.maxSteeringForce="undefined"==typeof b.maxSteeringForce?10:b.maxSteeringForce,this.seekTarget=b.seekTarget||null,this.flocking=!!b.flocking,this.desiredSeparation="undefined"==typeof b.desiredSeparation?2*this.width:b.desiredSeparation,this.separateStrength="undefined"==typeof b.separateStrength?.3:b.separateStrength,this.alignStrength="undefined"==typeof b.alignStrength?.2:b.alignStrength,this.cohesionStrength="undefined"==typeof b.cohesionStrength?.1:b.cohesionStrength,this.flowField=b.flowField||null,this.sensors=b.sensors||[],this.color=b.color||[197,177,115],this.borderWidth=b.borderWidth||0,this.borderStyle=b.borderStyle||"none",this.borderColor=b.borderColor||"transparent",this.borderRadius=b.borderRadius||this.sensors.length?100:0,this.separateSumForceVector=new Burner.Vector,this.alignSumForceVector=new Burner.Vector,this.cohesionSumForceVector=new Burner.Vector,this.followTargetVector=new Burner.Vector,this.followDesiredVelocity=new Burner.Vector,Burner.System.updateCache(this)},c.prototype.applyForces=function(){var a,b,c,d,e,f,h,i;if(this.sensors.length>0)for(a=0,b=this.sensors.length;b>a;a+=1)d=this.sensors[a],e=d.offsetDistance,f=g.degreesToRadians(this.angle+d.offsetAngle),h=e*Math.cos(f),i=e*Math.sin(f),d.location.x=this.location.x,d.location.y=this.location.y,d.location.add(new Burner.Vector(h,i)),a&&(d.borderStyle="none"),d.activated&&(this.applyForce(d.getActivationForce(this)),c=!0);return this.seekTarget&&this.applyForce(this._seek(this.seekTarget)),this.flocking&&this.flock(Burner.System.getAllItemsByName(this.name)),this.acceleration},c.prototype.flock=function(a){return this.applyForce(this.separate(a).mult(this.separateStrength)),this.applyForce(this.align(a).mult(this.alignStrength)),this.applyForce(this.cohesion(a).mult(this.cohesionStrength)),this.acceleration},c.prototype.separate=function(a){var b,c,d,e,f,g,h=0;for(this.separateSumForceVector.x=0,this.separateSumForceVector.y=0,g=this.separateSumForceVector,b=0,c=a.length;c>b;b+=1)d=a[b],this.className===d.className&&this.id!==d.id&&(f=this.location.distance(d.location),f>0&&f<this.desiredSeparation&&(e=Burner.Vector.VectorSub(this.location,d.location),e.normalize(),e.div(f),g.add(e),h+=1));return h>0?(g.div(h),g.normalize(),g.mult(this.maxSpeed),g.sub(this.velocity),g.limit(this.maxSteeringForce),g):new Burner.Vector},c.prototype.align=function(a){var b,c,d,e,f,g=2*this.width,h=0;for(this.alignSumForceVector.x=0,this.alignSumForceVector.y=0,f=this.alignSumForceVector,b=0,c=a.length;c>b;b+=1)d=a[b],e=this.location.distance(d.location),e>0&&g>e&&this.className===d.className&&this.id!==d.id&&(f.add(d.velocity),h+=1);return h>0?(f.div(h),f.normalize(),f.mult(this.maxSpeed),f.sub(this.velocity),f.limit(this.maxSteeringForce),f):new Burner.Vector},c.prototype.cohesion=function(a){var b,c,d,e,f,g=10,h=0;for(this.cohesionSumForceVector.x=0,this.cohesionSumForceVector.y=0,f=this.cohesionSumForceVector,b=0,c=a.length;c>b;b+=1)d=a[b],e=this.location.distance(d.location),e>0&&g>e&&this.className===d.className&&this.id!==d.id&&(f.add(d.location),h+=1);return h>0?(f.div(h),f.sub(this.location),f.normalize(),f.mult(this.maxSpeed),f.sub(this.velocity),f.limit(this.maxSteeringForce),f):new Burner.Vector},g.extend(d,h),d.prototype.init=function(a){var b=a||{};d._superClass.prototype.init.call(this,b),this.type=b.type||"",this.behavior=b.behavior||"LOVE",this.sensitivity="undefined"==typeof b.sensitivity?2:b.sensitivity,this.width="undefined"==typeof b.width?7:b.width,this.height="undefined"==typeof b.height?7:b.height,this.offsetDistance="undefined"==typeof b.offsetDistance?30:b.offsetDistance,this.offsetAngle=b.offsetAngle||0,this.opacity="undefined"==typeof b.opacity?.75:b.opacity,this.target=b.target||null,this.activated=!!b.activated,this.activatedColor=b.activatedColor||[255,255,255],this.borderRadius="undefined"==typeof b.borderRadius?100:b.borderRadius,this.borderWidth="undefined"==typeof b.borderWidth?2:b.borderWidth,this.borderStyle="solid",this.borderColor=[255,255,255]},d.prototype.step=function(){var a,b,c=!1,d=Burner.System._caches.Sheep||{list:[]};if("sheep"===this.type&&d.list&&d.list.length>0)for(a=0,b=d.list.length;b>a;a++)this.isInside(this,d.list[a],this.sensitivity)&&(this.target=d.list[a],this.activated=!0,c=!0);c?this.color=this.activatedColor:(this.target=null,this.activated=!1,this.color="transparent"),this.afterStep&&this.afterStep.apply(this)},d.prototype.getActivationForce=function(a){var b,c,d;return"AGGRESSIVE"===this.behavior?(c=Burner.Vector.VectorSub(this.target.location,this.location),b=c.mag(),c.normalize(),d=b/a.maxSpeed,c.mult(d),c.sub(a.velocity),c.limit(a.maxSteeringForce),c):new Burner.Vector},d.prototype.isInside=function(a,b,c){return a.location.x+a.width/2>b.location.x-b.width/2-c*b.width&&a.location.x-a.width/2<b.location.x+b.width/2+c*b.width&&a.location.y+a.height/2>b.location.y-b.height/2-c*b.height&&a.location.y-a.height/2<b.location.y+b.height/2+c*b.height?!0:!1},g.extend(e,d),e.prototype.step=function(){var a,b,c=!1,d=Burner.System._caches.Sheep||{list:[]};if("sheep"===this.type&&d.list&&d.list.length>0)for(a=0,b=d.list.length;b>a;a++)this.isInside(this,d.list[a],this.sensitivity)&&(this.target=d.list[a],this.activated=!0,c=!0);c?this.color=this.activatedColor:(this.target=null,this.activated=!1,this.color="transparent"),this.afterStep&&this.afterStep.apply(this)},e.prototype.getActivationForce=function(a){var b,c,d;return"AGGRESSIVE"===this.behavior?(c=Burner.Vector.VectorSub(this.target.location,this.location),b=c.mag(),c.normalize(),d=b/a.maxSpeed,c.mult(d),c.sub(a.velocity),c.limit(a.maxSteeringForce),c):new Burner.Vector},g.extend(f,d),f.prototype.step=function(){var a,b,c=!1,d=Burner.System._caches.Wolf||{list:[]};if("wolf"===this.type&&d.list&&d.list.length>0)for(a=0,b=d.list.length;b>a;a++)this.isInside(this,d.list[a],this.sensitivity)&&(this.target=d.list[a],this.activated=!0,c=!0);c?this.color=this.activatedColor:(this.target=null,this.activated=!1,this.color="transparent"),this.afterStep&&this.afterStep.apply(this)},f.prototype.getActivationForce=function(a){var b,c,d;return"COWARD"===this.behavior?(c=Burner.Vector.VectorSub(this.target.location,this.location),b=c.mag(),c.normalize(),d=b/a.maxSpeed,c.mult(-d),c.sub(a.velocity),c.limit(a.maxSteeringForce),c):new Burner.Vector};var i=150,j=1;Burner.Classes.Animal=c,Burner.Classes.SensorWolf=f,Burner.Classes.SensorSheep=e;var k=new Burner.World(b.body,{gravity:new Burner.Vector,c:0,width:960,height:960,boundToWindow:!1});Burner.System.init(function(){{var a,b=this,c=Flora.Utils.getRandomNumber;Flora.Utils.getWindowSize(),this.add("Walker",{wrapWorldEdges:!1,maxSpeed:2})}for(a=0;i>a;a++)this.add("Animal",{name:"Sheep",location:new Burner.Vector(c(0,k.width),c(0,k.height)),flocking:!0,avoidWorldEdges:!0,avoidWorldEdgesStrength:100,sensors:[b.add("SensorWolf",{type:"wolf",behavior:"COWARD",sensitivity:7,offsetDistance:0})]});var d=function(){var a,b,c=Burner.System._caches.Sheep;if(c)for(b=c.list.length,a=0;b>a;a++)c.lookup[c.list[a].id]&&this.isInside(c.list[a])&&e.call(this,c.list[a])},e=function(a){console.log("caught sheep:",a),b.add("Animal",{name:"Wolf",color:[89,207,78],location:a.location,flocking:!0,avoidWorldEdges:!0,avoidWorldEdgesStrength:100,sensors:[b.add("SensorSheep",{type:"sheep",behavior:"AGGR",sensitivity:10,offsetDistance:0})],beforeStep:d}),a.sensors.length>0&&b.destroyItem(a.sensors[0]),b.destroyItem(a)};for(a=0;j>a;a++)this.add("Animal",{name:"Wolf",color:[89,207,78],flocking:!0,avoidWorldEdges:!0,avoidWorldEdgesStrength:100,sensors:[this.add("SensorSheep",{type:"sheep",behavior:"AGGRESSIVE",sensitivity:5,offsetDistance:0})],beforeStep:d});this.add("InputMenu",{opacity:.4,borderColor:"transparent",position:"bottom center"})},k)}(window,document);